<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<title>2.5D Adventure — FINAL NO SCALE</title>
<style>
    body {
        margin: 0;
        background: #0b1220;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
    }

    /* ❗ Tidak ada width/height CSS di canvas */
    canvas {
        background: #1b3b5e;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,.6);
        image-rendering: pixelated;
    }
</style>
</head>
<body>

<canvas id="game" width="1200" height="700"></canvas>

<script>
/* ======================================================
       2.5D ADVENTURE — FINAL VERSION (NO SCALING)
   ====================================================== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const W = canvas.width;
const H = canvas.height;

/* ============================= WORLD MAP ============================= */

const world = {
    groundY: 560,
    length: 3600,
    platforms: [
        {x: 0,    y: 560, w: 3600, h: 40},
        {x: 420,  y: 460, w: 260,  h: 40},
        {x: 880,  y: 400, w: 260,  h: 40},
        {x: 1320, y: 340, w: 220,  h: 40},
        {x: 1760, y: 420, w: 260,  h: 40},
        {x: 2260, y: 360, w: 200,  h: 40},
        {x: 2680, y: 450, w: 320,  h: 40},
    ]
};

/* ============================= OBJECTS ============================= */

let items = [
    {id:"bucket", name:"Ember", x:2300, y:world.groundY-40, taken:false}
];

let npcs = [
    {id:"farmer", name:"Petani", x:3150, y:world.groundY-80, talked:false}
];

/* ============================= PLAYER ============================= */

const player = {
    x: 120,
    y: world.groundY - 100,
    w: 48,
    h: 70,
    vx: 0,
    vy: 0,
    speed: 380,
    jumpPower: -780,
    grounded: false,
    facing: 1,
    inventory: []
};

/* ============================= INPUT ============================= */

let keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup",   e => keys[e.key.toLowerCase()] = false);

/* =========================== COLLISION ============================ */

function platformsUnderX(x){
    return world.platforms.filter(p => x >= p.x && x <= p.x + p.w);
}

/* =========================== PHYSICS ============================ */

const GRAVITY = 2400;

function updatePhysics(dt){
    let prevFootY = player.y + player.h;

    // Movement
    let mv = 0;
    if (keys["a"] || keys["arrowleft"])  mv -= 1;
    if (keys["d"] || keys["arrowright"]) mv += 1;

    player.vx = mv * player.speed;
    if (mv !== 0) player.facing = mv > 0 ? 1 : -1;

    // Jump
    if ((keys["w"] || keys[" "]) && player.grounded){
        player.vy = player.jumpPower;
        player.grounded = false;
    }

    player.vy += GRAVITY * dt;

    player.x += player.vx * dt;
    player.y += player.vy * dt;

    // Bounds
    if (player.x < 0) player.x = 0;
    if (player.x > world.length - player.w) player.x = world.length - player.w;

    // Collision with platform
    let footX = player.x + player.w/2;
    let footY = player.y + player.h;

    let candidates = platformsUnderX(footX);
    let landed = null;

    for (let p of candidates){
        let top = p.y;
        if (prevFootY <= top && footY >= top && player.vy >= 0){
            if (!landed || top < landed.y){
                landed = p;
            }
        }
    }

    if (landed){
        player.y = landed.y - player.h;
        player.vy = 0;
        player.grounded = true;
        return;
    }

    // Collision with ground
    if (prevFootY <= world.groundY && footY >= world.groundY){
        player.y = world.groundY - player.h;
        player.vy = 0;
        player.grounded = true;
        return;
    }

    player.grounded = false;
}

/* =========================== CAMERA ============================ */

let camX = 0;

function updateCamera(dt){
    let target = player.x - W * 0.4;
    camX += (target - camX) * dt * 12;
    camX = Math.max(0, Math.min(camX, world.length - W));
}

/* =========================== INTERACTION ============================ */

function tryInteract(){
    for (let it of items){
        if (!it.taken && Math.abs(it.x - player.x) < 80){
            it.taken = true;
            player.inventory.push(it);
            console.log("Mengambil:", it.name);
            return;
        }
    }

    for (let n of npcs){
        if (Math.abs(n.x - player.x) < 90){
            if (!n.talked){
                console.log(`${n.name}: "Halo pendatang!"`);
                n.talked = true;
            } else {
                console.log(`${n.name}: "Kamu kembali?"`);
            }
            return;
        }
    }

    console.log("Tidak ada interaksi");
}

/* =========================== RENDER ============================ */

function drawBackground(){
    let g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,"#76c6ff");
    g.addColorStop(1,"#1d4f8a");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);
}

function drawPlatform(p){
    let x = p.x - camX;
    ctx.fillStyle = "#69c447";       // top
    ctx.fillRect(x, p.y-12, p.w, 12);

    ctx.fillStyle = "#3f7b2e";       // front
    ctx.fillRect(x, p.y, p.w, p.h);
}

function drawPlayer(){
    let x = player.x - camX;

    // shadow
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.beginPath();
    ctx.ellipse(x+player.w/2, player.y+player.h, 22, 8, 0,0,Math.PI*2);
    ctx.fill();

    // body
    ctx.fillStyle = "#ffd85a";
    ctx.fillRect(x, player.y, player.w, player.h);

    // head
    ctx.fillStyle = "#fff0c0";
    ctx.beginPath();
    ctx.arc(x+player.w/2, player.y-10, 22, 0, Math.PI*2);
    ctx.fill();
}

function drawItems(){
    for (let it of items){
        if (it.taken) continue;
        let x = it.x - camX;
        ctx.fillStyle = "#e8a03a";
        ctx.fillRect(x-20, it.y-40, 40, 40);
    }
}

function drawNPCs(){
    ctx.font = "14px Arial";
    ctx.fillStyle = "#fff";

    for (let n of npcs){
        let x = n.x - camX;
        ctx.fillStyle = "#7eb3ff";
        ctx.fillRect(x-20, n.y-60, 40, 60);

        ctx.fillStyle = "#fff";
        ctx.fillText(n.name, x-20, n.y-70);
    }
}

function render(){
    ctx.clearRect(0,0,W,H);

    drawBackground();
    for (let p of world.platforms) drawPlatform(p);

    drawItems();
    drawNPCs();
    drawPlayer();
}

/* =========================== LOOP ============================ */

let last = performance.now();
let consume = {};

function loop(t){
    let dt = (t-last)/1000;
    last = t;
    if (dt > 0.05) dt = 0.05;

    updatePhysics(dt);
    updateCamera(dt);

    if (keys["e"] && !consume.e){ tryInteract(); consume.e = true; }
    if (!keys["e"]) consume.e = false;

    render();
    requestAnimationFrame(loop);
}

window.addEventListener("keydown", e=>{
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key))
        e.preventDefault();
});

loop();

</script>
</body>
</html>
