<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>2.5D Adventure â€” FIXED</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body { margin:0; background:#0b1220; display:flex; justify-content:center; align-items:center; height:100vh; }
  canvas { width:1200px; height:700px; background:#1c3557; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,.6); }
</style>
</head>
<body>

<canvas id="game" width="1200" height="700"></canvas>

<script>
/* =============== CANVAS =============== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const W = canvas.width;
const H = canvas.height;

/* =============== WORLD =============== */

const world = {
  groundY: 560,
  length: 3400,
  platforms: [
    {x:0, y:560, w:3400, h:20},        // big ground
    {x:400, y:460, w:260, h:20},
    {x:800, y:400, w:260, h:20},
    {x:1260, y:340, w:200, h:20},
    {x:1680, y:410, w:260, h:20},
    {x:2200, y:360, w:200, h:20},
    {x:2600, y:450, w:300, h:20}
  ]
};

/* =============== OBJECTS =============== */

let items = [
  {id:"bucket", name:"Ember", x:2260, y:world.groundY - 40, taken:false}
];

let npcs = [
  {id:"farmer", name:"Petani", x:3100, y:world.groundY - 80, talked:false}
];

/* =============== PLAYER =============== */

const player = {
  x: 100,
  y: world.groundY - 80,
  w: 48,
  h: 64,
  vx: 0,
  vy: 0,
  speed: 380,
  jumpPower: -780,
  grounded: false,
  facing: 1,
  inventory: []
};

/* =============== CONTROLS =============== */

let keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

/* =============== PHYSICS FIX =============== */

function findPlatformUnder(px, py){
  let best = null;
  let bestDist = Infinity;

  for (let p of world.platforms){
    if (px >= p.x && px <= p.x + p.w){
      let top = p.y;
      if (top >= py){
        let dist = top - py;
        if (dist < bestDist){
          bestDist = dist;
          best = p;
        }
      }
    }
  }
  return best;
}

const GRAVITY = 2200;

function updatePhysics(dt){
  /* Horizontal movement */
  let move = 0;
  if (keys["a"] || keys["arrowleft"]) move -= 1;
  if (keys["d"] || keys["arrowright"]) move += 1;

  player.vx = move * player.speed;
  if (move !== 0) player.facing = move > 0 ? 1 : -1;

  /* Jump */
  if ((keys["w"] || keys[" "]) && player.grounded){
    player.vy = player.jumpPower;
    player.grounded = false;
  }

  /* Apply gravity */
  player.vy += GRAVITY * dt;

  /* Integrate */
  player.x += player.vx * dt;
  player.y += player.vy * dt;

  /* Check ground/platforms */
  let footX = player.x + player.w/2;
  let footY = player.y + player.h;

  let platform = findPlatformUnder(footX, footY);

  if (platform){
    if (footY > platform.y - 40 && player.vy >= 0){
      player.y = platform.y - player.h;
      player.vy = 0;
      player.grounded = true;
    }
  } else {
    if (footY > world.groundY){
      player.y = world.groundY - player.h;
      player.vy = 0;
      player.grounded = true;
    }
  }

  /* World bounds */
  if (player.x < 0) player.x = 0;
  if (player.x > world.length - player.w) player.x = world.length - player.w;
}

/* =============== INTERACTION =============== */

function tryInteract(){
  /* ITEM PICKUP */
  for (let it of items){
    if (it.taken) continue;

    let dx = Math.abs(it.x - player.x);
    if (dx < 70){
      it.taken = true;
      player.inventory.push(it);
      console.log("Ambil item:", it.name);
      return;
    }
  }

  /* NPC TALK */
  for (let n of npcs){
    let dx = Math.abs(n.x - player.x);
    if (dx < 90){
      if (!n.talked){
        console.log(`${n.name}: "Terima kasih sudah datang!"`);
        n.talked = true;
      } else {
        console.log(`${n.name}: "Halo lagi!"`);
      }
      return;
    }
  }

  console.log("Tidak ada yang bisa diinteraksi.");
}

/* =============== CAMERA =============== */
let cameraX = 0;

function updateCamera(dt){
  let target = player.x - W*0.4;
  cameraX += (target - cameraX) * dt * 10;

  if (cameraX < 0) cameraX = 0;
  if (cameraX > world.length - W) cameraX = world.length - W;
}

/* =============== RENDER =============== */

function drawPlatform(p){
  ctx.fillStyle = "#6aa84f";
  ctx.fillRect(p.x - cameraX, p.y, p.w, p.h);

  ctx.fillStyle = "#3f6540";
  ctx.fillRect(p.x - cameraX, p.y, p.w, 8);
}

function drawPlayer(){
  ctx.fillStyle = "#ffd85a";
  ctx.fillRect(player.x - cameraX, player.y, player.w, player.h);

  ctx.fillStyle = "#ffefbf";
  ctx.beginPath();
  ctx.arc(player.x - cameraX + player.w/2, player.y, 18, 0, Math.PI*2);
  ctx.fill();
}

function drawItems(){
  for (let it of items){
    if (it.taken) continue;

    ctx.fillStyle = "#e8a03a";
    ctx.fillRect(it.x - cameraX - 20, it.y - 40, 40, 40);
  }
}

function drawNPCs(){
  for (let n of npcs){
    ctx.fillStyle = "#88b4ff";
    ctx.fillRect(n.x - cameraX - 20, n.y - 60, 40, 60);

    ctx.fillStyle = "#fff";
    ctx.fillText(n.name, n.x - cameraX - 20, n.y - 70);
  }
}

function render(){
  ctx.clearRect(0,0,W,H);

  /* sky */
  let g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0, "#7ecfff");
  g.addColorStop(1, "#2b6ea9");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  /* platforms */
  for (let p of world.platforms) drawPlatform(p);

  /* items */
  drawItems();

  /* NPC */
  drawNPCs();

  /* player */
  drawPlayer();
}

/* =============== MAIN LOOP =============== */

let last = performance.now();
function loop(t){
  let dt = (t - last) / 1000;
  last = t;

  if (dt > 0.05) dt = 0.05;

  updatePhysics(dt);
  updateCamera(dt);

  if (keys["e"] && !consume.e){ tryInteract(); consume.e = true; }
  if (!keys["e"]) consume.e = false;

  render();
  requestAnimationFrame(loop);
}
let consume = {};

/* Prevent arrow key scroll */
window.addEventListener("keydown", e=>{
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key))
    e.preventDefault();
});

loop();
</script>

</body>
</html>
